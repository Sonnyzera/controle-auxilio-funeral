<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Dados - Auxílio Funeral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-8">
            <div class="text-left">
                 <h1 class="text-3xl font-bold text-gray-700">Controle e Exportação de Dados</h1>
                 <p class="text-md text-gray-500 mt-1">Dados salvos e acessados diretamente da nuvem.</p>
            </div>
            <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">
                Sair
            </button>
        </header>

        <!-- Formulário -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Adicionar Novo Registro</h2>
            <form id="data-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="md:col-span-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">Tipo de Registro</label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center"><input type="radio" name="tipo" value="Urna" class="h-4 w-4" checked> <span class="ml-2">Urna</span></label>
                        <label class="flex items-center"><input type="radio" name="tipo" value="Translado" class="h-4 w-4"> <span class="ml-2">Translado</span></label>
                    </div>
                </div>
                <div id="origem-container"><label for="origem-solicitacao" class="block text-sm font-medium">Origem</label><select id="origem-solicitacao" class="mt-1 block w-full p-2 border rounded-md" required><option>UPA ITINGA</option><option>SEMDESC</option></select></div>
                <div><label for="data-solicitacao" class="block text-sm font-medium">Data Solicitação</label><input type="date" id="data-solicitacao" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="requerente" class="block text-sm font-medium">Requerente</label><input type="text" id="requerente" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="cpf-requerente" class="block text-sm font-medium">CPF (Requerente)</label><input type="text" id="cpf-requerente" placeholder="000.000.000-00" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="telefone-requerente" class="block text-sm font-medium">Telefone</label><input type="tel" id="telefone-requerente" placeholder="(00) 00000-0000" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="falecido" class="block text-sm font-medium">Falecido(a)</label><input type="text" id="falecido" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="idade-falecido" class="block text-sm font-medium">Idade (Falecido)</label><input type="number" id="idade-falecido" min="0" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="md:col-span-2 grid grid-cols-2 gap-2">
                    <div><label for="tipo-documento-falecido" class="block text-sm font-medium">Documento</label><select id="tipo-documento-falecido" class="mt-1 block w-full p-2 border rounded-md" required><option value="CPF">CPF</option><option value="RG">RG</option><option value="Certidao">Certidão Nasc.</option></select></div>
                    <div><label for="documento-falecido" class="block text-sm font-medium">Número</label><input type="text" id="documento-falecido" class="mt-1 block w-full p-2 border rounded-md" required></div>
                </div>
                <div><label for="data-obito" class="block text-sm font-medium">Data do Óbito</label><input type="date" id="data-obito" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="col-span-1"><label for="onibus" class="block text-sm font-medium">Qtd. de Ônibus</label><input type="number" id="onibus" min="0" placeholder="Qtd" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="valor" class="block text-sm font-medium">Valor</label><input type="number" id="valor" step="0.01" min="0" placeholder="0.00" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="md:col-span-4 flex justify-end"><button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md">Adicionar</button></div>
            </form>
        </div>

        <!-- Tabela -->
        <div class="bg-white p-6 rounded-lg shadow-md">
             <div class="flex flex-col lg:flex-row justify-between lg:items-center gap-4 mb-4">
                <h2 class="text-xl font-semibold">Registros Salvos</h2>
                <div class="w-full lg:w-auto flex flex-col sm:flex-row items-center gap-2">
                    <div class="w-full sm:w-auto flex items-center gap-2"><select id="month-filter" class="w-full p-2 border rounded-md"><option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option><option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option></select><input type="number" id="year-filter" placeholder="Ano" class="p-2 border rounded-md w-24"></div>
                    <div class="w-full sm:w-auto flex flex-col sm:flex-row gap-2"><button id="export-urna" class="w-full bg-blue-600 text-white p-2 rounded-md disabled:bg-gray-400">Exportar Urnas</button><button id="export-translado" class="w-full bg-green-600 text-white p-2 rounded-md disabled:bg-gray-400">Exportar Translados</button></div>
                </div>
            </div>
            <div class="overflow-x-auto"><table class="min-w-full divide-y"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Origem</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Data Solic.</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Requerente</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Falecido(a)</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Idade</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Ação</th></tr></thead><tbody id="data-table-body" class="bg-white divide-y"></tbody></table><p id="no-data-message" class="text-center py-8">Carregando dados...</p></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBGp5lqn5caaaV1d6ajXX2jqCwIZDi8V20",
          authDomain: "controle-funeral-app.firebaseapp.com",
          projectId: "controle-funeral-app",
          storageBucket: "controle-funeral-app.appspot.com",
          messagingSenderId: "131856655468",
          appId: "1:131856655468:web:a43a9d665365c8b4b9e449"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const form = document.getElementById('data-form');
        const tableBody = document.getElementById('data-table-body');
        const noDataMessage = document.getElementById('no-data-message');
        
        let dataStore = [];

        // --- AUTENTICAÇÃO ---
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = '/login.html';
            } else {
                carregarDados();
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth);
        });

        // --- LÓGICA DO FIRESTORE ---
        const carregarDados = async () => {
            const q = query(collection(db, "registros"), orderBy("dataSolicitacao", "desc"));
            const querySnapshot = await getDocs(q);
            dataStore = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable();
        };

        const adicionarRegistro = async (novoRegistro) => {
            try {
                await addDoc(collection(db, "registros"), novoRegistro);
                carregarDados();
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
            }
        };

        const deletarRegistro = async (id) => {
            if (!confirm('Tem certeza que deseja excluir este registro?')) return;
            await deleteDoc(doc(db, "registros", id));
            carregarDados();
        };

        // --- LÓGICA DA UI (sem grandes alterações) ---
        const renderTable = () => {
            tableBody.innerHTML = '';
            if (dataStore.length === 0) {
                noDataMessage.textContent = 'Nenhum registro encontrado.';
                noDataMessage.style.display = 'block';
            } else {
                noDataMessage.style.display = 'none';
                dataStore.forEach(rowData => {
                    const row = document.createElement('tr');
                    const formatDate = (dateStr) => dateStr ? new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR') : '';
                    row.innerHTML = `
                        <td class="px-6 py-4">${rowData.tipo}</td>
                        <td class="px-6 py-4">${rowData.origemSolicitacao}</td>
                        <td class="px-6 py-4">${formatDate(rowData.dataSolicitacao)}</td>
                        <td class="px-6 py-4">${rowData.requerente}</td>
                        <td class="px-6 py-4">${rowData.falecido}</td>
                        <td class="px-6 py-4">${rowData.idadeFalecido || ''}</td>
                        <td class="px-6 py-4"><button data-id="${rowData.id}" class="text-red-600 hover:text-red-900 delete-btn">Excluir</button></td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            // Habilitar/desabilitar botões de exportação
            document.getElementById('export-urna').disabled = !dataStore.some(d => d.tipo === 'Urna');
            document.getElementById('export-translado').disabled = !dataStore.some(d => d.tipo === 'Translado');
        };

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const novoRegistro = {
                tipo: form.tipo.value,
                origemSolicitacao: form['origem-solicitacao'].value,
                dataSolicitacao: form['data-solicitacao'].value,
                requerente: form.requerente.value,
                cpfRequerente: form['cpf-requerente'].value,
                telefoneRequerente: form['telefone-requerente'].value,
                falecido: form.falecido.value,
                idadeFalecido: form['idade-falecido'].value,
                tipoDocumentoFalecido: form['tipo-documento-falecido'].value,
                documentoFalecido: form['documento-falecido'].value,
                dataObito: form['data-obito'].value,
                onibus: form.onibus.value,
                valor: form.valor.value
            };
            adicionarRegistro(novoRegistro);
            form.reset();
        });

        tableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                deletarRegistro(e.target.getAttribute('data-id'));
            }
        });

        // --- LÓGICA DE EXPORTAÇÃO E MÁSCARAS (sem alterações) ---
        const exportToXLSX = (tipo) => {
            const monthFilter = document.getElementById('month-filter');
            const yearFilter = document.getElementById('year-filter');
            const selectedMonth = parseInt(monthFilter.value, 10);
            const selectedYear = parseInt(yearFilter.value, 10);

            if (!selectedYear || selectedYear.toString().length !== 4) {
                alert('Por favor, insira um ano válido com 4 dígitos.');
                return;
            }

            const dataToExport = dataStore.filter(row => {
                if (!row.dataSolicitacao || row.tipo !== tipo) return false;
                const rowDate = new Date(row.dataSolicitacao + 'T00:00:00');
                return rowDate.getMonth() + 1 === selectedMonth && rowDate.getFullYear() === selectedYear;
            });

            if (dataToExport.length === 0) {
                alert(`Nenhum registro do tipo "${tipo}" encontrado para ${selectedMonth}/${selectedYear}.`);
                return;
            }

            const mappedData = dataToExport.map(row => ({
                'Tipo': row.tipo, 'Origem da Solicitação': row.origemSolicitacao, 'Data da Solicitação': row.dataSolicitacao,
                'Requerente': row.requerente, 'CPF do Requerente': row.cpfRequerente, 'Telefone do Requerente': row.telefoneRequerente,
                'Falecido(a)': row.falecido, 'Idade do Falecido': row.idadeFalecido, 'Tipo Documento Falecido': row.tipoDocumentoFalecido,
                'Documento Falecido': row.documentoFalecido, 'Data do Óbito': row.dataObito, 'Qtd. de Ônibus': row.onibus, 'Valor': row.valor
            }));

            const worksheet = XLSX.utils.json_to_sheet(mappedData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, tipo);
            XLSX.writeFile(workbook, `Relatorio_${tipo}_${selectedMonth}-${selectedYear}.xlsx`);
        };
        
        document.getElementById('export-urna').addEventListener('click', () => exportToXLSX('Urna'));
        document.getElementById('export-translado').addEventListener('click', () => exportToXLSX('Translado'));

        // --- INICIALIZAÇÃO ---
        const setInitialDateFilters = () => {
            const today = new Date();
            document.getElementById('month-filter').value = today.getMonth() + 1;
            document.getElementById('year-filter').value = today.getFullYear();
        };
        setInitialDateFilters();
    </script>
</body>
</html>
