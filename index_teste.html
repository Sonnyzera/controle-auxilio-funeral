<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Dados (TESTE) - Auxílio Funeral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; visibility: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .hidden { display: none; }
        /* Estilos para impressão */
        @media print {
            @page {
                size: landscape;
            }
            body * {
                visibility: hidden;
            }
            #print-section, #print-section * {
                visibility: visible;
            }
            #print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-8">
            <div class="text-left">
                 <h1 class="text-3xl font-bold text-red-500">AMBIENTE DE TESTE</h1>
                 <p class="text-md text-gray-500 mt-1">Dados salvos e acessados do banco de dados de TESTE.</p>
            </div>
            <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm">
                Sair
            </button>
        </header>

        <!-- Formulário -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Adicionar Novo Registro de Teste</h2>
            <form id="data-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="md:col-span-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">Tipo de Registro <span class="text-red-500">*</span></label>
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center"><input type="radio" name="tipo" value="Urna" class="h-4 w-4" required> <span class="ml-2">Urna</span></label>
                        <label class="flex items-center"><input type="radio" name="tipo" value="Translado" class="h-4 w-4" required> <span class="ml-2">Translado</span></label>
                    </div>
                </div>
                <div id="origem-container"><label for="origem-solicitacao" class="block text-sm font-medium">Origem</label><select id="origem-solicitacao" class="mt-1 block w-full p-2 border rounded-md" required></select></div>
                <div><label for="numero-registro" class="block text-sm font-medium">Nº de Registro</label><input type="text" id="numero-registro" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="data-solicitacao" class="block text-sm font-medium">Data Solicitação</label><input type="date" id="data-solicitacao" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="requerente" class="block text-sm font-medium">Requerente</label><input type="text" id="requerente" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="cpf-requerente" class="block text-sm font-medium">CPF (Requerente)</label><input type="text" id="cpf-requerente" placeholder="000.000.000-00" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="telefone-requerente" class="block text-sm font-medium">Telefone</label><input type="tel" id="telefone-requerente" placeholder="(00) 00000-0000" class="mt-1 block w-full p-2 border rounded-md"></div>
                <div><label for="falecido" class="block text-sm font-medium">Falecido(a)</label><input type="text" id="falecido" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="idade-falecido" class="block text-sm font-medium">Idade (Falecido)</label><input type="number" id="idade-falecido" min="0" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="md:col-span-2 grid grid-cols-2 gap-2">
                    <div><label for="tipo-documento-falecido" class="block text-sm font-medium">Documento</label><select id="tipo-documento-falecido" class="mt-1 block w-full p-2 border rounded-md" required><option value="" disabled selected>Selecione...</option><option value="CPF">CPF</option><option value="RG">RG</option><option value="Certidao">Certidão Nasc.</option></select></div>
                    <div><label for="documento-falecido" class="block text-sm font-medium">Número</label><input type="text" id="documento-falecido" class="mt-1 block w-full p-2 border rounded-md" required></div>
                </div>
                <div><label for="data-obito" class="block text-sm font-medium">Data do Óbito</label><input type="date" id="data-obito" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div id="onibus-container" class="col-span-1"><label for="onibus" class="block text-sm font-medium">Qtd. de Ônibus</label><input type="number" id="onibus" min="0" placeholder="Qtd" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div><label for="valor" class="block text-sm font-medium">Valor</label><input type="text" id="valor" placeholder="R$ 0,00" class="mt-1 block w-full p-2 border rounded-md" required></div>
                <div class="md:col-span-4 flex justify-end"><button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md">Adicionar</button></div>
            </form>
        </div>

        <!-- Tabela -->
        <div class="bg-white p-6 rounded-lg shadow-md">
             <div class="flex flex-col lg:flex-row justify-between lg:items-center gap-4 mb-4">
                <h2 class="text-xl font-semibold">Registros Salvos (Teste)</h2>
                <div class="w-full lg:w-auto flex flex-col sm:flex-row items-center gap-2">
                    <div class="w-full sm:w-auto flex items-center gap-2"><select id="month-filter" class="w-full p-2 border rounded-md"><option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option><option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option><option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option><option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option></select><input type="number" id="year-filter" placeholder="Ano" class="p-2 border rounded-md w-24"></div>
                    <div class="w-full sm:w-auto flex flex-col sm:flex-row gap-2">
                        <button id="print-button" class="w-full bg-gray-500 text-white p-2 rounded-md disabled:bg-gray-400">Imprimir Relatório</button>
                        <button id="export-urna" class="w-full bg-blue-600 text-white p-2 rounded-md disabled:bg-gray-400">Exportar Urnas</button>
                        <button id="export-translado" class="w-full bg-green-600 text-white p-2 rounded-md disabled:bg-gray-400">Exportar Translados</button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto"><table class="min-w-full divide-y"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase">Nº</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Nº Reg.</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Tipo</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Origem</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Data Solic.</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Requerente</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Falecido(a)</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Idade</th><th class="px-6 py-3 text-left text-xs font-medium uppercase">Ação</th></tr></thead><tbody id="data-table-body" class="bg-white divide-y"></tbody><tfoot id="data-table-footer" class="bg-gray-50 font-bold"></tfoot></table><p id="no-data-message" class="text-center py-8">Carregando dados...</p></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBGp5lqn5caaaV1d6ajXX2jqCwIZDi8V20",
          authDomain: "controle-funeral-app.firebaseapp.com",
          projectId: "controle-funeral-app",
          storageBucket: "controle-funeral-app.appspot.com",
          messagingSenderId: "131856655468",
          appId: "1:131856655468:web:a43a9d665365c8b4b9e449"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const collectionName = "registros_teste";

        const form = document.getElementById('data-form');
        const tableBody = document.getElementById('data-table-body');
        const tableFooter = document.getElementById('data-table-footer');
        const noDataMessage = document.getElementById('no-data-message');
        const tipoRadios = document.querySelectorAll('input[name="tipo"]');
        const origemSelect = document.getElementById('origem-solicitacao');
        const valorInput = document.getElementById('valor');
        const tipoDocumentoFalecidoSelect = document.getElementById('tipo-documento-falecido');
        const documentoFalecidoInput = document.getElementById('documento-falecido');
        const printButton = document.getElementById('print-button');
        const onibusContainer = document.getElementById('onibus-container');
        const onibusInput = document.getElementById('onibus');
        
        let dataStore = [];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.body.style.visibility = 'visible';
                carregarDados();
            } else {
                window.location.href = '/login.html';
            }
        });

        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

        const carregarDados = async () => {
            const q = query(collection(db, collectionName), orderBy("dataSolicitacao", "desc"));
            const querySnapshot = await getDocs(q);
            dataStore = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable();
        };

        const adicionarRegistro = async (novoRegistro) => {
            try {
                await addDoc(collection(db, collectionName), novoRegistro);
                carregarDados();
            } catch (e) { console.error("Erro ao adicionar documento: ", e); }
        };

        const deletarRegistro = async (id) => {
            if (!confirm('Tem certeza que deseja excluir este registro?')) return;
            await deleteDoc(doc(db, collectionName, id));
            carregarDados();
        };

        const renderTable = () => {
            tableBody.innerHTML = '';
            tableFooter.innerHTML = '';
            
            if (dataStore.length === 0) {
                noDataMessage.textContent = 'Nenhum registro encontrado.';
                noDataMessage.style.display = 'block';
            } else {
                noDataMessage.style.display = 'none';
                let totalValor = 0;
                dataStore.forEach((rowData, index) => {
                    const row = document.createElement('tr');
                    const formatDate = (dateStr) => dateStr ? new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR') : '';
                    totalValor += parseFloat(rowData.valor) || 0;
                    row.innerHTML = `
                        <td class="px-6 py-4 font-bold">${index + 1}</td>
                        <td class="px-6 py-4">${rowData.numeroRegistro || ''}</td>
                        <td class="px-6 py-4">${rowData.tipo}</td>
                        <td class="px-6 py-4">${rowData.origemSolicitacao}</td>
                        <td class="px-6 py-4">${formatDate(rowData.dataSolicitacao)}</td>
                        <td class="px-6 py-4">${rowData.requerente}</td>
                        <td class="px-6 py-4">${rowData.falecido}</td>
                        <td class="px-6 py-4">${rowData.idadeFalecido ? rowData.idadeFalecido + ' ANOS' : ''}</td>
                        <td class="px-6 py-4"><button data-id="${rowData.id}" class="text-red-600 hover:text-red-900 delete-btn">Excluir</button></td>
                    `;
                    tableBody.appendChild(row);
                });

                // Render Footer
                const footerRow = document.createElement('tr');
                footerRow.innerHTML = `
                    <td class="px-6 py-4 text-right font-bold" colspan="8">Total de Atendimentos: ${dataStore.length}</td>
                    <td class="px-6 py-4 font-bold" colspan="1">Soma Total: ${totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                `;
                tableFooter.appendChild(footerRow);
            }
            document.getElementById('export-urna').disabled = !dataStore.some(d => d.tipo === 'Urna');
            document.getElementById('export-translado').disabled = !dataStore.some(d => d.tipo === 'Translado');
            printButton.disabled = dataStore.length === 0;
        };

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const valorNumerico = parseFloat(valorInput.value.replace('R$', '').replace(/\./g, '').replace(',', '.').trim());
            const tipoSelecionado = form.tipo.value;
            const novoRegistro = {
                tipo: tipoSelecionado,
                origemSolicitacao: form['origem-solicitacao'].value,
                numeroRegistro: form['numero-registro'].value,
                dataSolicitacao: form['data-solicitacao'].value,
                requerente: form.requerente.value,
                cpfRequerente: form['cpf-requerente'].value,
                telefoneRequerente: form['telefone-requerente'].value,
                falecido: form.falecido.value,
                idadeFalecido: form['idade-falecido'].value,
                tipoDocumentoFalecido: form['tipo-documento-falecido'].value,
                documentoFalecido: form['documento-falecido'].value,
                dataObito: form['data-obito'].value,
                onibus: tipoSelecionado === 'Translado' ? form.onibus.value : '0',
                valor: isNaN(valorNumerico) ? 0 : valorNumerico
            };
            adicionarRegistro(novoRegistro);
            form.reset();
            handleTipoChange();
        });

        tableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                deletarRegistro(e.target.getAttribute('data-id'));
            }
        });

        const formatCurrency = (input) => {
            let value = input.value.replace(/\D/g, '');
            value = (value / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            input.value = value;
        };
        valorInput.addEventListener('input', () => formatCurrency(valorInput));

        const applyMask = (event) => {
            let value = event.target.value.replace(/\D/g, '');
            const inputId = event.target.id;
            if (inputId === 'cpf-requerente' || (inputId === 'documento-falecido' && tipoDocumentoFalecidoSelect.value === 'CPF')) {
                value = value.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                event.target.value = value.slice(0, 14);
            } else if (inputId === 'telefone-requerente') {
                value = value.replace(/^(\d{2})(\d)/g, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2');
                event.target.value = value.slice(0, 15);
            }
        };
        ['cpf-requerente', 'telefone-requerente', 'documento-falecido'].forEach(id => document.getElementById(id).addEventListener('input', applyMask));
        
        tipoDocumentoFalecidoSelect.addEventListener('change', () => {
            documentoFalecidoInput.value = '';
            documentoFalecidoInput.placeholder = tipoDocumentoFalecidoSelect.value === 'CPF' ? '000.000.000-00' : 'Apenas números';
        });

        const handleTipoChange = () => {
            const tipoSelecionado = document.querySelector('input[name="tipo"]:checked')?.value;
            if (tipoSelecionado === 'Urna') {
                origemSelect.innerHTML = '<option>UPA ITINGA</option><option>SEMDESC</option>';
                origemSelect.disabled = false;
                onibusContainer.classList.add('hidden');
                onibusInput.required = false;
            } else if (tipoSelecionado === 'Translado') {
                origemSelect.innerHTML = '<option selected>SEMDESC</option>';
                origemSelect.disabled = true;
                onibusContainer.classList.remove('hidden');
                onibusInput.required = true;
            } else {
                 origemSelect.innerHTML = '';
                 onibusContainer.classList.add('hidden');
                 onibusInput.required = false;
            }
        };
        tipoRadios.forEach(radio => radio.addEventListener('change', handleTipoChange));
        
        const getFilteredData = () => {
            const monthFilter = document.getElementById('month-filter');
            const yearFilter = document.getElementById('year-filter');
            const selectedMonth = parseInt(monthFilter.value, 10);
            const selectedYear = parseInt(yearFilter.value, 10);

            if (!selectedYear || selectedYear.toString().length !== 4) {
                alert('Por favor, insira um ano válido com 4 dígitos.');
                return null;
            }

            const dataToProcess = dataStore.filter(row => {
                if (!row.dataSolicitacao) return false;
                const rowDate = new Date(row.dataSolicitacao + 'T00:00:00');
                return rowDate.getMonth() + 1 === selectedMonth && rowDate.getFullYear() === selectedYear;
            });

            return { data: dataToProcess, month: selectedMonth, year: selectedYear };
        };

        const exportToXLSX = (tipo) => {
            const filteredResult = getFilteredData();
            if (!filteredResult) return;

            const { data, month, year } = filteredResult;
            const dataToExport = data.filter(row => row.tipo === tipo);

            if (dataToExport.length === 0) {
                alert(`Nenhum registro do tipo "${tipo}" encontrado para ${month}/${year}.`);
                return;
            }
            
            const formatDateForExcel = (dateStr) => dateStr ? new Date(dateStr + 'T00:00:00').toLocaleDateString('pt-BR') : '';
            let totalValor = 0;

            const mappedData = dataToExport.map((row, index) => {
                totalValor += parseFloat(row.valor) || 0;
                return {
                'Nº': index + 1, 'Nº Registro': row.numeroRegistro, 'Tipo': row.tipo, 'Origem da Solicitação': row.origemSolicitacao, 
                'Data da Solicitação': formatDateForExcel(row.dataSolicitacao), 'Requerente': row.requerente, 
                'CPF do Requerente': row.cpfRequerente, 'Telefone do Requerente': row.telefoneRequerente,
                'Falecido(a)': row.falecido, 'Idade do Falecido': row.idadeFalecido ? `${row.idadeFalecido} ANOS` : '', 
                'Tipo Documento Falecido': row.tipoDocumentoFalecido, 'Documento Falecido': row.documentoFalecido, 
                'Data do Óbito': formatDateForExcel(row.dataObito), 'Qtd. de Ônibus': row.onibus, 'Valor': row.valor
            }});

            mappedData.push({
                'Nº': '', 'Nº Registro': '', 'Tipo': '', 'Origem da Solicitação': '', 
                'Data da Solicitação': '', 'Requerente': '', 
                'CPF do Requerente': '', 'Telefone do Requerente': '',
                'Falecido(a)': '', 'Idade do Falecido': '', 
                'Tipo Documento Falecido': '', 'Documento Falecido': '', 
                'Data do Óbito': 'Total de Atendimentos:', 'Qtd. de Ônibus': dataToExport.length, 'Valor': totalValor
            });

            const worksheet = XLSX.utils.json_to_sheet(mappedData);
            worksheet['!cols'] = [ {wch:5}, {wch:10}, {wch:10}, {wch:20}, {wch:20}, {wch:25}, {wch:20}, {wch:25}, {wch:15}, {wch:20}, {wch:20}, {wch:20}, {wch:15}, {wch:15}, {wch:15} ];
            
            dataToExport.forEach((row, index) => {
                const cellRef = XLSX.utils.encode_cell({c: 14, r: index + 1});
                if(worksheet[cellRef]) {
                    worksheet[cellRef].t = 'n';
                    worksheet[cellRef].z = 'R$ #,##0.00';
                }
            });
            const totalCellRef = XLSX.utils.encode_cell({c: 14, r: dataToExport.length + 1});
            if(worksheet[totalCellRef]) {
                worksheet[totalCellRef].t = 'n';
                worksheet[totalCellRef].z = 'R$ #,##0.00';
            }


            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, tipo);
            XLSX.writeFile(workbook, `Relatorio_${tipo}_${month}-${year}.xlsx`);
        };

        const printReport = () => {
            const filteredResult = getFilteredData();
            if (!filteredResult) return;
            
            const { data, month, year } = filteredResult;

            if (data.length === 0) {
                alert(`Nenhum registro encontrado para ${month}/${year} para imprimir.`);
                return;
            }

            const monthNames = ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"];
            const monthName = monthNames[month - 1];
            let totalValor = 0;

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Relatório de Atendimentos</title>');
            printWindow.document.write(`
                <style>
                    body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
                    .content-wrapper { width: 95%; }
                    .report-header { height: 80px; margin-bottom: 20px; } /* Espaço para a logo */
                    .report-title { text-align: center; font-size: 14px; font-weight: bold; margin-bottom: 20px; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; font-size: 9px; }
                    th { background-color: #f2f2f2; }
                    tfoot { font-weight: bold; }
                    @page { size: landscape; margin: 15mm; }
                </style>
            `);
            printWindow.document.write('</head><body><div class="content-wrapper">');
            printWindow.document.write('<div class="report-header"></div>');
            printWindow.document.write(`<div class="report-title">Relatório de Atendimentos - ${monthName}/${year}</div>`);
            let tableHTML = '<table><thead><tr>';
            const headers = ['Nº', 'Nº Reg.', 'Tipo', 'Origem', 'Data Solic.', 'Requerente', 'Falecido(a)', 'Idade', 'Documento', 'Telefone', 'Valor'];
            headers.forEach(h => tableHTML += `<th>${h}</th>`);
            tableHTML += '</tr></thead><tbody>';

            data.forEach((row, index) => {
                totalValor += parseFloat(row.valor) || 0;
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${row.numeroRegistro || ''}</td>
                        <td>${row.tipo || ''}</td>
                        <td>${row.origemSolicitacao || ''}</td>
                        <td>${row.dataSolicitacao ? new Date(row.dataSolicitacao + 'T00:00:00').toLocaleDateString('pt-BR') : ''}</td>
                        <td>${row.requerente || ''}</td>
                        <td>${row.falecido || ''}</td>
                        <td>${row.idadeFalecido ? row.idadeFalecido + ' ANOS' : ''}</td>
                        <td>${row.documentoFalecido || ''}</td>
                        <td>${row.telefoneRequerente || ''}</td>
                        <td>${(row.valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody>';
            tableHTML += `
                <tfoot>
                    <tr>
                        <td colspan="10" style="text-align: right;">Total de Atendimentos: ${data.length}</td>
                        <td>${totalValor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    </tr>
                </tfoot>
            `;
            tableHTML += '</table></div></body></html>';
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 500);
        };
        
        document.getElementById('export-urna').addEventListener('click', () => exportToXLSX('Urna'));
        document.getElementById('export-translado').addEventListener('click', () => exportToXLSX('Translado'));
        printButton.addEventListener('click', printReport);
        
        const setInitialDateFilters = () => {
            const today = new Date();
            document.getElementById('month-filter').value = today.getMonth() + 1;
            document.getElementById('year-filter').value = today.getFullYear();
        };
        setInitialDateFilters();
        handleTipoChange();
    </script>
</body>
</html>
